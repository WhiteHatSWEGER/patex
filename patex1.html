<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Gas Sensor Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            margin: 0;
            padding: 20px;
        }
        .container, .container-fluid {
            max-width: 1200px;
        }
        .chart, .messages, .event-log, .monitor {
            background-color: #ffffff;
            border: 1px solid #e1e1e1;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        .chart canvas, .event-log table, .monitor table {
            width: 100%;
        }
        .log-table th, .log-table td, .monitor-table th, .monitor-table td {
            border-color: #e1e1e1;
        }
        .message {
            border: 1px solid #e1e1e1;
            border-radius: 5px;
            margin-bottom: 10px;
            padding: 10px;
        }
        .alert-danger {
            background-color: #ff3b30;
            color: white;
        }
        .alert-warning {
            background-color: #ff9500;
            color: white;
        }
        .alert-success {
            background-color: #34c759;
            color: white;
        }
        footer {
            margin-top: 40px;
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="container-fluid">
        <ul>
            <li><strong>Gas Sensor Dashboard</strong></li>
        </ul>
        <ul>
            <li><a href="#">Dashboard</a></li>
            <li><a href="#">Sensors</a></li>
            <li><a href="#" role="button">Settings</a></li>
        </ul>
    </nav>
    <main class="container">
        <div class="grid">
            <section>
                <div class="chart">
                    <div id="chart-legend"></div>
                    <canvas id="hourly-data-chart"></canvas>
                    <div class="loading" style="display: none;">Loading...</div>
                </div>
                <div class="messages">
                    <div class="message alert-danger">
                        <strong>System 1 ist fehlerhaft.</strong>
                    </div>
                    <div class="message alert-warning">
                        <strong>System 2 hat Anzeichen von Problemen.</strong>
                    </div>
                    <div class="message alert-success">
                        <strong>System 3 ist fehlerfrei.</strong>
                    </div>
                </div>
                <div class="event-log">
                    <h2>Event Log</h2>
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>Level</th>
                                <th>Timestamp</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="event-log-table">
                            <!-- Event data will be dynamically added here -->
                        </tbody>
                    </table>
                </div>
                <div class="monitor">
                    <h2>Last Messages</h2>
                    <div class="monitor-table-container">
                        <table class="monitor-table">
                            <thead>
                                <tr>
                                    <th>Sensor</th>
                                    <th>Value</th>
                                    <th>Unit</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody id="sensor-data-table">
                                <!-- Sensor data will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <footer class="container">
        <small><a href="#">Privacy Policy</a> â€¢ <a href="#">Terms of Service</a></small>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/min/moment.min.js"></script>
        <script>
            fetchSensorData();
            updateChart();
            updateEventLogTable();
            updateTable();
            function customDateFormat(date) {
                const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
                return new Intl.DateTimeFormat('en-US', options).format(date);
            }
          
            const ctx = document.getElementById('hourly-data-chart').getContext('2d');
            const chart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: [], // Time labels will be pushed here in your 'addDataPoint' function
                datasets: [] // Data for the chart will be added dynamically here
              },
              options: {
                tooltips: {
                  enabled: true,
                  callbacks: {
                    label: function(tooltipItem, data) {
                      const value = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                      return value;
                    }
                  }
                },
                scales: {
                  yAxes: [{
                    ticks: {
                      beginAtZero: true,
                      max: 100,
                      min: 0,
                      stepSize: 10
                    }
                  }],
                  xAxes: [{
                    type: 'time',
                    time: {
                      unit: 'minute',
                      displayFormats: {
                        minute: 'HH:mm'
                      }
                    },
                    ticks: {
                      display: true, // Set this to true to display the labels
                      callback: function(value, index, values) {
                        // Assuming your labels array contains JavaScript Date objects
                        return customDateFormat(values[index].value);
                      }
                    },
                    gridLines: {
                      display: false // Set to false to hide the grid lines
                    }
                  }]
                }
              }
            });
        
            function updateChart(labels, datasets) {
              chart.data.labels = labels;
              chart.data.datasets = datasets;
              chart.update();
            }
        
            function addDataPoint(label, value, color) {
                const labels = chart.data.labels;if (labels.length === 0) {
                  chart.data.labels.push(label);
                  chart.data.datasets = [{
                    label: label,
                    data: [value],
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 1
                  }];
                } else {
                  const lastDataset = chart.data.datasets[chart.data.datasets.length - 1];
                  lastDataset.data.push(value);
                  chart.data.labels.push(label);
                }
                if (labels.length > 100) {
                  labels.shift();
                  chart.data.datasets.forEach(dataset => {
                    dataset.data.shift();
                  });
                }
                chart.update();
              }
        
            async function fetchSensorData() {
                try {
                  const currentTime = Math.floor(Date.now() / 1000);
                  const oneHourAgo = currentTime - 60 *60;
              
                  const response = await fetch('https://your-domain.com/api/sensor-data?from=' + oneHourAgo + '&to=' + currentTime);
                  if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                  }
                  const data = await response.json();
                  return data;
                } catch (error) {
                    console.error('Error fetching data:', error);
                    
                    // Get current time as a fallback for the error data point
                    const errorTime = new Date();
                
                    // Add error data point to chart
                    addDataPoint(errorTime, 0, "rgba(255, 99, 132, 0.5)"); // Using an RGBA color for consistency with the chart's data
                
                    // Add error row to table
                    const tableBody = document.getElementById('sensor-data-table');
                    const errorRow = document.createElement('tr');
                    errorRow.classList.add('error-row');
                    const errorCell = document.createElement('td');
                    errorCell.colSpan = 4;
                    errorCell.textContent = 'Error fetching data (308/404)';
                    errorRow.appendChild(errorCell);
                    tableBody.appendChild(errorRow);
                
                    // It's unclear what should be returned here, it seems like it's supposed to be a single sensor data object,
                    // but you're returning an array with an object that has a formatted timestamp
                    // and a value of 0. If this return value is meant to be processed elsewhere to update the chart,
                    // make sure that place can handle this format and knows it's an error condition.
                    return [{ Timestamp: errorTime, Value: 0 }];
                }
              }

              async function initializeChart() {
                const sensorData = await fetchSensorData();
                // Here you would process sensorData and update the chart
                // For demonstration, let's add a mock data point
                addDataPoint('2024-01-01T00:00:00Z', 20, 'rgba(255, 99, 132, 1)');

                // Initialize other elements (tables, etc.) as needed
            }

            function addDataPoint(timestamp, value, color) {
                sensorChart.data.labels.push(timestamp);
                sensorChart.data.datasets.push({
                    label: timestamp, // Or any label you prefer
                    data: [value],
                    backgroundColor: color,
                    borderColor: color,
                    fill: false
                });
                sensorChart.update();
            }

            initializeChart();
        
            async function updateTable() {
              const sensorData = await fetchSensorData();
              const tableBody = document.getElementById('sensor-data-table');
              tableBody.innerHTML = '';
        
              const datasets = [];
        
              for (const [sensorName, sensorDataObj] of Object.entries(sensorData)) {
                const row = document.createElement('tr');
                const sensorNameCell = document.createElement('td');
                sensorNameCell.textContent = sensorName;
                sensorNameCell.classList.add('sensor-name');
                row.appendChild(sensorNameCell);
        
                const measureCell = document.createElement('td');
                measureCell.textContent = sensorDataObj.Measure;
                row.appendChild(measureCell);
        
                const valueCell = document.createElement('td');
                valueCell.textContent = sensorDataObj.Value;
                valueCell.classList.add('value');
                row.appendChild(valueCell);
        
                const criticalCell =document.createElement('td');
                criticalCell.textContent = sensorDataObj.Critical ? 'Yes' : 'No';
                row.appendChild(criticalCell);
        
                const warningCell = document.createElement('td');
                warningCell.textContent = sensorDataObj.Warning ? 'Yes' : 'No';
                row.appendChild(warningCell);
        
                tableBody.appendChild(row);
                
        
                // Add data point to chart
                const color = getRandomColor();
                addDataPoint(customDateFormat(sensorDataObj.Timestamp), sensorDataObj.Value, color);
        
                // Add dataset to legend
                const legend = document.getElementById('chart-legend');
                const legendItem = document.createElement('span');
                legendItem.style.backgroundColor = color;
                legendItem.style.display = 'inline-block';
                legendItem.style.width = '10px';
                legendItem.style.height = '10px';
                legendItem.style.marginRight = '5px';
                legendItem.style.borderRadius = '50%';
                const legendLabel = document.createElement('span');
                legendLabel.textContent =sensorName;
                legend.appendChild(legendItem);
                legend.appendChild(legendLabel);
              }
            }
        
            function getRandomColor() {
              return '#' + Math.floor(Math.random()*16777215).toString(16);
            }
        
            // Aktualisierung der Sensortabelle alle 5 Sekunden
            setInterval(updateTable, 5000);
        
            // Fetch data and update table on page load
            updateTable();
        
            // Fetch event log data and update table on page load
            async function fetchEventLogData() {
              try {
                const response = await fetch('https://your-domain.com/api/event-log');
                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data;
              } catch (error) {
                console.error('Error fetching event log data:', error);
                return [];
              }
            }
        
            async function updateEventLogTable() {
              const eventLogData = await fetchEventLogData();
              const eventLogTableBody = document.getElementById('event-log-table');
              eventLogTableBody.innerHTML = '';
        
              for (const eventLogEntry of eventLogData) {
                const row = document.createElement('tr');
                const levelCell = document.createElement('td');
                levelCell.textContent = eventLogEntry.level;
                row.appendChild(levelCell);
        
                const timestampCell = document.createElement('td');
                timestampCell.textContent = new Date(eventLogEntry.timestamp).toLocaleString();
                row.appendChild(timestampCell);
        
                const messageCell = document.createElement('td');
                messageCell.textContent = eventLogEntry.message;
                row.appendChild(messageCell);
        
                eventLogTableBody.appendChild(row);
              }
                // Fetch event log data and update table on page load
                updateEventLogTable();
            
                // Update event log table every 10 seconds
                setInterval(updateEventLogTable, 10000);
            }
        
            setInterval(fetchSensorData, 5000)
    </script>
</body>
</html>
